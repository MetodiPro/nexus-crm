<div class="card max-w-4xl mx-auto">
  <div class="card-header bg-nexus-dark text-white">
    <h4 class="text-lg font-semibold">
      <i class="fas fa-file-contract"></i> 
      <%= contract.id ? 'Modifica Contratto' : 'Nuovo Contratto' %>
    </h4>
  </div>
  <div class="card-body">
    <form action="<%= action %>" method="POST" onsubmit="return validateForm('contractForm')" id="contractForm">
      <% if (contract.client_id) { %>
        <input type="hidden" name="redirect_to_client" value="true">
      <% } %>
      
      <div class="mb-4">
        <label for="client_id" class="form-label">Cliente *</label>
        <select class="form-select" id="client_id" name="client_id" required>
          <option value="">Seleziona cliente...</option>
          <% clients.forEach(client => { %>
            <option value="<%= client.id %>" <%= (contract.client_id == client.id) ? 'selected' : '' %>>
              <%= client.name %> <%= client.surname %> 
              <% if (client.company) { %>
                - <%= client.company %>
              <% } %>
            </option>
          <% }) %>
        </select>
      </div>
      
      <!-- Selezione prodotto da listino -->
      <div class="mb-4">
        <label for="product_id" class="form-label">Seleziona dal Listino</label>
        <select class="form-select" id="product_id" name="product_id">
          <option value="">Seleziona prodotto/servizio...</option>
          <% products.forEach(product => { %>
            <option 
              value="<%= product.id %>" 
              <%= (contract.product_id == product.id) ? 'selected' : '' %>
              data-energy-type="<%= product.energy_type %>"
              data-supplier="<%= product.supplier %>"
              data-price="<%= product.base_price %>"
            >
              <%= product.name %> - 
              <%= product.energy_type === 'electricity' ? 'Energia Elettrica' : 
                 product.energy_type === 'gas' ? 'Gas Naturale' : 
                 product.energy_type === 'both' ? 'Dual Fuel' : product.energy_type %>
              <% if (product.supplier) { %>
                - <%= product.supplier %>
              <% } %>
            </option>
          <% }) %>
        </select>
        <p class="text-xs text-gray-500 mt-1">La selezione di un prodotto dal listino compilerà automaticamente alcuni campi</p>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label for="contract_type" class="form-label">Tipo Contratto *</label>
          <input type="text" class="form-input" id="contract_type" name="contract_type" 
                 value="<%= contract.contract_type || '' %>" required
                 placeholder="es. Rinnovo, Nuovo allaccio, Subentro...">
        </div>
        <div>
          <label for="energy_type" class="form-label">Tipo Energia *</label>
          <select class="form-select" id="energy_type" name="energy_type" required>
            <option value="">Seleziona tipo...</option>
            <option value="electricity" <%= (contract.energy_type === 'electricity') ? 'selected' : '' %>>
              Energia Elettrica
            </option>
            <option value="gas" <%= (contract.energy_type === 'gas') ? 'selected' : '' %>>
              Gas Naturale
            </option>
            <option value="both" <%= (contract.energy_type === 'both') ? 'selected' : '' %>>
              Dual Fuel (Elettricità + Gas)
            </option>
          </select>
        </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label for="supplier" class="form-label">Fornitore</label>
          <input type="text" class="form-input" id="supplier" name="supplier" 
                 value="<%= contract.supplier || '' %>">
        </div>
        <div>
          <label for="value" class="form-label">Valore (€)</label>
          <input type="number" step="0.01" min="0" class="form-input" id="value" name="value" 
                 value="<%= contract.value || '' %>">
        </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label for="start_date" class="form-label">Data Inizio</label>
          <input type="date" class="form-input" id="start_date" name="start_date" 
                 value="<%= contract.start_date ? contract.start_date.split('T')[0] : '' %>">
        </div>
        <div>
          <label for="end_date" class="form-label">Data Fine</label>
          <input type="date" class="form-input" id="end_date" name="end_date" 
                 value="<%= contract.end_date ? contract.end_date.split('T')[0] : '' %>">
        </div>
      </div>
      
      <div class="mb-4">
        <label for="status" class="form-label">Stato *</label>
        <select class="form-select" id="status" name="status" required>
          <option value="pending" <%= (contract.status === 'pending') ? 'selected' : '' %>>
            In attesa
          </option>
          <option value="accepted" <%= (contract.status === 'accepted') ? 'selected' : '' %>>
            Accettato
          </option>
          <option value="rejected" <%= (contract.status === 'rejected') ? 'selected' : '' %>>
            Rifiutato
          </option>
        </select>
      </div>
      
      <div class="mb-6">
        <label for="notes" class="form-label">Note</label>
        <textarea class="form-input h-24" id="notes" name="notes"><%= contract.notes || '' %></textarea>
      </div>
      
      <div class="flex justify-between">
        <a href="<%= contract.client_id ? '/clients/view/' + contract.client_id : '/contracts' %>" class="btn-outline">
          <i class="fas fa-arrow-left"></i> Annulla
        </a>
        <button type="submit" class="btn-primary">
          <i class="fas fa-save"></i> Salva
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  // Script per autocompilare i campi quando si seleziona un prodotto dal listino
  document.addEventListener('DOMContentLoaded', function() {
    const productSelect = document.getElementById('product_id');
    const energyTypeSelect = document.getElementById('energy_type');
    const supplierInput = document.getElementById('supplier');
    const valueInput = document.getElementById('value');
    
    if (productSelect) {
      productSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        
        if (this.value) {
          // Imposta il tipo di energia
          if (selectedOption.dataset.energyType) {
            energyTypeSelect.value = selectedOption.dataset.energyType;
          }
          
          // Imposta il fornitore
          if (selectedOption.dataset.supplier) {
            supplierInput.value = selectedOption.dataset.supplier;
          }
          
          // Imposta il prezzo
          if (selectedOption.dataset.price) {
            valueInput.value = selectedOption.dataset.price;
          }
        }
      });
    }
  });
</script>