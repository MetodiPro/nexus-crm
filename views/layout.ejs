<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NEXUS CRM</title>
  <!-- Tailwind CSS -->
  <link rel="stylesheet" href="/css/styles.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
  <% if (locals.user) { %>
    <!-- Layout con sidebar -->
    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar mobile overlay -->
      <div id="sidebar-overlay" class="fixed inset-0 bg-black opacity-50 z-20 hidden lg:hidden"></div>
      
      <!-- Sidebar -->
      <aside id="sidebar" class="bg-nexus-dark text-white w-64 flex-shrink-0 fixed inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 z-30 lg:static lg:z-auto transition duration-200 ease-in-out overflow-y-auto">
        <div class="flex flex-col h-full">
          <!-- Logo -->
          <div class="py-4 px-6 border-b border-gray-700">
            <a href="/dashboard" class="text-nexus-red font-bold text-xl">NEXUS</a>
            <p class="text-sm text-gray-400">Sistema CRM</p>
          </div>

          <!-- Menu -->
          <nav class="flex-1 py-4 px-4">
            <ul class="space-y-1">
              <!-- Dashboard Analytics -->
              <li>
                <a href="/dashboard" class="sidebar-link">
                  <i class="fas fa-tachometer-alt w-5 text-center mr-2"></i> Dashboard
                </a>
              </li>
              
              <!-- Clienti -->
              <li>
                <a href="/clients" class="sidebar-link">
                  <i class="fas fa-users w-5 text-center mr-2"></i> Clienti
                </a>
              </li>
              
              <!-- Punti di Fornitura -->
              <li>
                <a href="/supply-points" class="sidebar-link">
                  <i class="fas fa-plug w-5 text-center mr-2"></i> Punti di Fornitura
                </a>
              </li>
              
              <% if (user.role === 'administrator') { %>
                <!-- Menu Prodotti/Servizi con sottomenu -->
                <li>
                  <div class="sidebar-menu-group">
                    <a href="/products" class="sidebar-link sidebar-parent">
                      <i class="fas fa-box w-5 text-center mr-2"></i> Prodotti/Servizi
                      <i class="fas fa-chevron-down ml-auto transition-transform duration-200" id="products-chevron"></i>
                    </a>
                    <ul class="sidebar-submenu hidden ml-6 mt-1" id="products-submenu">
                      <li>
                        <a href="/products/attachments" class="sidebar-sublink">
                          <i class="fas fa-file-pdf w-4 text-center mr-2 text-red-400"></i> Allegati Offerte
                        </a>
                      </li>
                    </ul>
                  </div>
                </li>
              <% } %>
              
              <!-- Menu Proposte/Contratti con sottomenu -->
              <li>
                <div class="sidebar-menu-group">
                  <a href="/contracts" class="sidebar-link sidebar-parent">
                    <i class="fas fa-file-contract w-5 text-center mr-2"></i> Proposte/Contratti
                    <i class="fas fa-chevron-down ml-auto transition-transform duration-200" id="contracts-chevron"></i>
                  </a>
                  <ul class="sidebar-submenu hidden ml-6 mt-1" id="contracts-submenu">
                    <li>
                      <a href="/utilities/expiring-contracts" class="sidebar-sublink">
                        <i class="fas fa-exclamation-triangle w-4 text-center mr-2 text-orange-400"></i> Contratti in Scadenza
                      </a>
                    </li>
                  </ul>
                </div>
              </li>
              
              <!-- Attività -->
              <li>
                <a href="/activities" class="sidebar-link">
                  <i class="fas fa-tasks w-5 text-center mr-2"></i> Attività
                </a>
              </li>
              
              <!-- Calendario -->
              <li>
                <a href="/activities/calendar" class="sidebar-link">
                  <i class="fas fa-calendar w-5 text-center mr-2"></i> Calendario
                </a>
              </li>
              
              <!-- Statistiche -->
              <li>
                <a href="/contracts/stats" class="sidebar-link">
                  <i class="fas fa-chart-bar w-5 text-center mr-2"></i> Statistiche
                </a>
              </li>
              
              <!-- Notifiche (per tutti gli utenti) -->
              <li>
                <a href="/notifications/settings" class="sidebar-link">
                  <i class="fas fa-bell w-5 text-center mr-2"></i> Notifiche
                </a>
              </li>
              
              <% if (user.role === 'administrator') { %>
                <!-- Gestione Notifiche (solo admin) -->
                <li>
                  <a href="/notifications" class="sidebar-link">
                    <i class="fas fa-cogs w-5 text-center mr-2"></i> Gestione Notifiche
                  </a>
                </li>
                
                <!-- Utenti -->
                <li>
                  <a href="/users" class="sidebar-link">
                    <i class="fas fa-user-cog w-5 text-center mr-2"></i> Utenti
                  </a>
                </li>
              <% } %>
            </ul>
          </nav>

          <!-- Footer -->
          <div class="border-t border-gray-700 p-4">
            <div class="text-xs text-gray-400">
              <p>NEXUS CRM &copy; <%= new Date().getFullYear() %></p>
              <p>Sistema gestione consulenza energetica</p>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main content -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Top navbar -->
        <header class="bg-nexus-dark text-white">
          <div class="flex items-center justify-between h-16 px-6">
            <!-- Mobile menu button -->
            <button id="mobile-menu-button" class="lg:hidden">
              <i class="fas fa-bars text-white"></i>
            </button>

            <!-- User actions -->
            <div class="flex-1 flex justify-end items-center">
              <div class="flex-shrink-0 text-white mr-4" id="user-info">
                <% if (locals.user && locals.user.id) { %>
                  <i class="fas fa-user mr-1"></i> <%= locals.user.name %> 
                  <span class="<%= locals.user.role === 'administrator' ? 'badge-red' : 'badge-gray' %> ml-2" id="user-role-badge">
                    <%= locals.user.role === 'administrator' ? 'Admin' : 'Consulente' %>
                  </span>
                <% } else { %>
                  <i class="fas fa-user mr-1"></i> UTENTE SCONOSCIUTO
                  <span class="badge-gray ml-2">ERROR</span>
                <% } %>
              </div>
              <a href="/logout" class="btn-outline-red btn-sm">
                <i class="fas fa-sign-out-alt"></i> Logout
              </a>
            </div>
          </div>
        </header>

        <!-- Page content -->
        <main class="flex-1 overflow-x-hidden overflow-y-auto p-6 bg-gray-50">
          <%- body %>
        </main>
      </div>
    </div>
  <% } else { %>
    <!-- Contenuto principale per utenti non autenticati -->
    <main class="container mx-auto px-4 py-8 flex-grow">
      <%- body %>
    </main>

    <!-- Footer -->
    <footer class="bg-nexus-dark text-white text-center py-3">
      <div class="container mx-auto">
        <small>NEXUS CRM &copy; <%= new Date().getFullYear() %> - Sistema di gestione consulenza energetica</small>
      </div>
    </footer>
  <% } %>

  <script src="/js/main.js"></script>
  
  <!-- Script per gestione sottomenu sidebar -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Gestione sottomenu Prodotti/Servizi
      const productsParent = document.querySelector('#products-submenu')?.parentElement.querySelector('.sidebar-parent');
      const productsSubmenu = document.getElementById('products-submenu');
      const productsChevron = document.getElementById('products-chevron');
      
      if (productsParent && productsSubmenu && productsChevron) {
        // Controlla se siamo in una pagina del sottomenu per aprirlo automaticamente
        const currentPath = window.location.pathname;
        if (currentPath.includes('/products/attachments')) {
          productsSubmenu.classList.remove('hidden');
          productsChevron.style.transform = 'rotate(180deg)';
        }
        
        productsParent.addEventListener('click', function(e) {
          // Se il click è sulla chevron o non è il link principale, previeni navigazione
          if (e.target.classList.contains('fa-chevron-down') || 
              e.target.id === 'products-chevron' ||
              (!e.target.href || !e.target.href.endsWith('/products'))) {
            e.preventDefault();
          }
          
          // Toggle del sottomenu
          productsSubmenu.classList.toggle('hidden');
          
          // Rotazione della chevron
          if (productsSubmenu.classList.contains('hidden')) {
            productsChevron.style.transform = 'rotate(0deg)';
          } else {
            productsChevron.style.transform = 'rotate(180deg)';
          }
        });
      }
      
      // Gestione sottomenu Proposte/Contratti
      const contractsParent = document.querySelector('#contracts-submenu')?.parentElement.querySelector('.sidebar-parent');
      const contractsSubmenu = document.getElementById('contracts-submenu');
      const contractsChevron = document.getElementById('contracts-chevron');
      
      if (contractsParent && contractsSubmenu && contractsChevron) {
        // Controlla se siamo in una pagina del sottomenu per aprirlo automaticamente
        const currentPath = window.location.pathname;
        if (currentPath.includes('/utilities/expiring-contracts')) {
          contractsSubmenu.classList.remove('hidden');
          contractsChevron.style.transform = 'rotate(180deg)';
        }
        
        contractsParent.addEventListener('click', function(e) {
          // Se il click è sulla chevron o non è il link principale, previeni navigazione
          if (e.target.classList.contains('fa-chevron-down') || 
              e.target.id === 'contracts-chevron' ||
              (!e.target.href || !e.target.href.endsWith('/contracts'))) {
            e.preventDefault();
          }
          
          // Toggle del sottomenu
          contractsSubmenu.classList.toggle('hidden');
          
          // Rotazione della chevron
          if (contractsSubmenu.classList.contains('hidden')) {
            contractsChevron.style.transform = 'rotate(0deg)';
          } else {
            contractsChevron.style.transform = 'rotate(180deg)';
          }
        });
      }
      
      // Evidenzia i link attivi nei sottomenu
      const subLinks = document.querySelectorAll('.sidebar-sublink');
      subLinks.forEach(link => {
        if (link.href === window.location.href) {
          link.classList.add('active');
        }
      });
    });
  </script>
</body>
</html>
