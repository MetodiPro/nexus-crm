<!-- Breadcrumb e Titolo -->
<div class="mb-6">
  <nav class="flex" aria-label="Breadcrumb">
    <ol class="inline-flex items-center space-x-1 md:space-x-3">
      <li class="inline-flex items-center">
        <a href="/" class="text-gray-700 hover:text-nexus-red">
          <i class="fas fa-home"></i> Dashboard
        </a>
      </li>
      <li>
        <div class="flex items-center">
          <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
          <a href="/clients" class="text-gray-700 hover:text-nexus-red">Clienti</a>
        </div>
      </li>
      <li>
        <div class="flex items-center">
          <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
          <a href="/clients/view/<%= client.id %>" class="text-gray-700 hover:text-nexus-red"><%= client.name %> <%= client.surname %></a>
        </div>
      </li>
      <li>
        <div class="flex items-center">
          <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
          <a href="/clients/<%= client.id %>/utilities" class="text-gray-700 hover:text-nexus-red">Utenze</a>
        </div>
      </li>
      <li aria-current="page">
        <div class="flex items-center">
          <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
          <span class="text-gray-500"><%= utility.id ? 'Modifica' : 'Nuova' %> Utenza Gas</span>
        </div>
      </li>
    </ol>
  </nav>
  <h1 class="text-3xl font-bold text-orange-600 mt-4">
    <i class="fas fa-fire mr-3"></i>
    <%= utility.id ? 'Modifica' : 'Nuova' %> Utenza Gas
  </h1>
  <p class="text-gray-600 mt-2">
    <i class="fas fa-user mr-2"></i>
    Cliente: <%= client.name %> <%= client.surname %>
    <% if (client.company) { %> - <%= client.company %><% } %>
  </p>
</div>

<div class="card max-w-4xl mx-auto">
  <div class="card-header bg-orange-600 text-white">
    <h4 class="text-lg font-semibold">
      <i class="fas fa-fire mr-2"></i>
      <%= utility.id ? 'Modifica Utenza Gas' : 'Nuova Utenza Gas' %>
    </h4>
    <p class="text-sm mt-1 opacity-90">
      Cliente: <%= client.name %> <%= client.surname %>
      <% if (client.company) { %> - <%= client.company %><% } %>
    </p>
  </div>
  <div class="card-body">
    <form action="<%= action %>" method="POST" onsubmit="return validateGasForm()" id="gasForm">
      
      <!-- IDENTIFICAZIONE UTENZA -->
      <div class="mb-6">
        <h5 class="text-lg font-semibold mb-3 text-orange-600 border-b border-gray-300 pb-2">
          <i class="fas fa-id-badge"></i> Identificazione Utenza
        </h5>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="pdr_code" class="form-label">Codice PDR *</label>
            <input type="text" class="form-input" id="pdr_code" name="pdr_code" 
                   value="<%= utility.pdr_code || '' %>" required
                   placeholder="23730905" maxlength="14">
            <p class="text-xs text-gray-500 mt-1">Codice numerico di 8-14 cifre</p>
          </div>
          <div>
            <label for="utility_name" class="form-label">Nome Descrittivo</label>
            <input type="text" class="form-input" id="utility_name" name="utility_name" 
                   value="<%= utility.utility_name || '' %>"
                   placeholder="es: Sede principale, Caldaia uffici, Cucina">
            <p class="text-xs text-gray-500 mt-1">Nome per identificare facilmente l'utenza</p>
          </div>
        </div>
      </div>

      <!-- DATI TECNICI -->
      <div class="mb-6">
        <h5 class="text-lg font-semibold mb-3 text-orange-600 border-b border-gray-300 pb-2">
          <i class="fas fa-cogs"></i> Dati Tecnici
        </h5>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="meter_type" class="form-label">Tipo Misuratore</label>
            <select class="form-input" id="meter_type" name="meter_type">
              <option value="">Seleziona...</option>
              <option value="tradizionale" <%= utility.meter_type === 'tradizionale' ? 'selected' : '' %>>Tradizionale</option>
              <option value="elettronico" <%= utility.meter_type === 'elettronico' ? 'selected' : '' %>>Elettronico</option>
              <option value="smart" <%= utility.meter_type === 'smart' ? 'selected' : '' %>>Smart Meter</option>
              <option value="telelettura" <%= utility.meter_type === 'telelettura' ? 'selected' : '' %>>Telelettura</option>
            </select>
          </div>
          <div>
            <label for="remi_code" class="form-label">Codice REMI</label>
            <input type="text" class="form-input" id="remi_code" name="remi_code" 
                   value="<%= utility.remi_code || '' %>"
                   placeholder="Codice identificativo rete">
            <p class="text-xs text-gray-500 mt-1">Codice REte di MIsura (opzionale)</p>
          </div>
        </div>
      </div>

      <!-- FORNITORE E CONTRATTO -->
      <div class="mb-6">
        <h5 class="text-lg font-semibold mb-3 text-orange-600 border-b border-gray-300 pb-2">
          <i class="fas fa-handshake"></i> Fornitore e Contratto
        </h5>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="supplier" class="form-label">Fornitore Attuale</label>
            <input type="text" class="form-input" id="supplier" name="supplier" 
                   value="<%= utility.supplier || '' %>"
                   placeholder="es: ENI Gas e Luce, Italgas, Snam">
          </div>
          <div>
            <label for="last_bill_date" class="form-label">Data Ultima Fattura</label>
            <input type="date" class="form-input" id="last_bill_date" name="last_bill_date" 
                   value="<%= utility.last_bill_date || '' %>">
          </div>
          <div>
            <label for="contract_start_date" class="form-label">Inizio Contratto</label>
            <input type="date" class="form-input" id="contract_start_date" name="contract_start_date" 
                   value="<%= utility.contract_start_date || '' %>">
          </div>
          <div>
            <label for="contract_end_date" class="form-label">Scadenza Contratto</label>
            <input type="date" class="form-input" id="contract_end_date" name="contract_end_date" 
                   value="<%= utility.contract_end_date || '' %>">
          </div>
        </div>
      </div>

      <!-- CONSUMI ANNUALI -->
      <div class="mb-6">
        <h5 class="text-lg font-semibold mb-3 text-orange-600 border-b border-gray-300 pb-2">
          <i class="fas fa-chart-area"></i> Consumi Annuali
        </h5>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="annual_consumption_smc" class="form-label">Consumo Annuale (Smc)</label>
            <input type="number" class="form-input" id="annual_consumption_smc" name="annual_consumption_smc" 
                   value="<%= utility.annual_consumption_smc || '' %>" min="0" max="99999999"
                   placeholder="es: 1200">
            <p class="text-xs text-gray-500 mt-1">Consumo in Standard Metro Cubo per anno</p>
          </div>
          <div>
            <label for="annual_consumption_year" class="form-label">Anno di Riferimento</label>
            <input type="number" class="form-input" id="annual_consumption_year" name="annual_consumption_year" 
                   value="<%= utility.annual_consumption_year || new Date().getFullYear() %>" 
                   min="2020" max="<%= new Date().getFullYear() + 1 %>">
          </div>
        </div>
        <div class="mt-4 p-4 bg-orange-50 rounded-lg">
          <div class="flex items-start">
            <div class="flex-shrink-0">
              <i class="fas fa-fire text-orange-500 text-lg"></i>
            </div>
            <div class="ml-3">
              <h6 class="text-orange-800 font-semibold text-sm">Suggerimenti per i Consumi Gas</h6>
              <ul class="text-orange-700 text-sm mt-1 space-y-1">
                <li>• <strong>Abitazione (riscaldamento + acqua calda):</strong> 800-1.500 Smc/anno</li>
                <li>• <strong>Abitazione (solo cottura):</strong> 100-300 Smc/anno</li>
                <li>• <strong>Piccola Attività commerciale:</strong> 500-2.000 Smc/anno</li>
                <li>• <strong>Media Attività industriale:</strong> 2.000-10.000 Smc/anno</li>
                <li>• <strong>Grande Industria:</strong> 10.000+ Smc/anno</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- INDIRIZZO SPECIFICO UTENZA -->
      <div class="mb-6">
        <h5 class="text-lg font-semibold mb-3 text-orange-600 border-b border-gray-300 pb-2 flex items-center justify-between">
          <span><i class="fas fa-map-marker-alt"></i> Indirizzo Utenza</span>
          <button type="button" class="btn-outline btn-sm text-xs" onclick="copyClientAddress()">
            <i class="fas fa-copy"></i> Copia da cliente
          </button>
        </h5>
        <p class="text-sm text-gray-600 mb-3">
          Compila solo se l'utenza è in un indirizzo diverso da quello del cliente
        </p>
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
          <div class="md:col-span-3">
            <label for="utility_address" class="form-label">Via/Piazza</label>
            <input type="text" class="form-input" id="utility_address" name="utility_address" 
                   value="<%= utility.utility_address || '' %>">
          </div>
          <div>
            <label for="utility_postal_code" class="form-label">CAP</label>
            <input type="text" class="form-input" id="utility_postal_code" name="utility_postal_code" 
                   value="<%= utility.utility_postal_code || '' %>" maxlength="5">
          </div>
          <div>
            <label for="utility_city" class="form-label">Comune</label>
            <input type="text" class="form-input" id="utility_city" name="utility_city" 
                   value="<%= utility.utility_city || '' %>">
          </div>
          <div>
            <label for="utility_province" class="form-label">Provincia</label>
            <input type="text" class="form-input" id="utility_province" name="utility_province" 
                   value="<%= utility.utility_province || '' %>" maxlength="2"
                   style="text-transform: uppercase">
          </div>
        </div>
      </div>

      <!-- NOTE E STATO -->
      <div class="mb-6">
        <h5 class="text-lg font-semibold mb-3 text-orange-600 border-b border-gray-300 pb-2">
          <i class="fas fa-sticky-note"></i> Note e Stato
        </h5>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="md:col-span-3">
            <label for="notes" class="form-label">Note Specifiche</label>
            <textarea class="form-input h-24" id="notes" name="notes" 
                      placeholder="Note specifiche per questa utenza gas..."><%= utility.notes || '' %></textarea>
          </div>
          <div>
            <label for="is_active" class="form-label">Stato Utenza</label>
            <select class="form-input" id="is_active" name="is_active">
              <option value="1" <%= utility.is_active !== 0 ? 'selected' : '' %>>Attiva</option>
              <option value="0" <%= utility.is_active === 0 ? 'selected' : '' %>>Disattivata</option>
            </select>
          </div>
        </div>
      </div>
      
      <div class="flex justify-between">
        <a href="/clients/<%= client.id %>/utilities" class="btn-outline">
          <i class="fas fa-arrow-left"></i> Annulla
        </a>
        <button type="submit" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded transition-colors">
          <i class="fas fa-save"></i> Salva Utenza Gas
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Dati cliente per JavaScript -->
<script>
const clientData = {
  address: '<%= client.address || "" %>',
  city: '<%= client.city || "" %>',
  postal_code: '<%= client.postal_code || "" %>',
  province: '<%= client.province || "" %>'
};

// Copia indirizzo cliente
function copyClientAddress() {
  if (confirm('Copiare l\'indirizzo del cliente in questa utenza?')) {
    document.getElementById('utility_address').value = clientData.address;
    document.getElementById('utility_city').value = clientData.city;
    document.getElementById('utility_postal_code').value = clientData.postal_code;
    document.getElementById('utility_province').value = clientData.province;
  }
}

// Validazione PDR
function validatePDR(input) {
  const pdr = input.value;
  const regex = /^[0-9]{8,14}$/;
  
  if (pdr && !regex.test(pdr)) {
    input.setCustomValidity('Formato PDR non valido. Deve contenere 8-14 cifre');
  } else {
    input.setCustomValidity('');
  }
}

// Validazione form
function validateGasForm() {
  const pdrInput = document.getElementById('pdr_code');
  validatePDR(pdrInput);
  
  if (!pdrInput.checkValidity()) {
    pdrInput.focus();
    return false;
  }
  
  return true;
}

// Event listeners
document.getElementById('pdr_code').addEventListener('blur', function() {
  validatePDR(this);
});

// Auto-calcolo costi stimati gas
document.getElementById('annual_consumption_smc').addEventListener('input', function() {
  const consumption = parseInt(this.value);
  if (consumption) {
    const estimatedCost = consumption * 1.20; // Stima €1.20/Smc
    const hint = document.getElementById('consumption_hint');
    if (!hint) {
      const hintElement = document.createElement('p');
      hintElement.id = 'consumption_hint';
      hintElement.className = 'text-xs text-blue-600 mt-1';
      this.parentNode.appendChild(hintElement);
    }
    document.getElementById('consumption_hint').textContent = 
      `Costo stimato annuale: €${estimatedCost.toLocaleString()} (basato su €1.20/Smc)`;
  }
});
</script>