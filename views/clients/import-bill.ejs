<!-- Breadcrumb e Titolo -->
<div class="mb-6">
  <nav class="flex" aria-label="Breadcrumb">
    <ol class="inline-flex items-center space-x-1 md:space-x-3">
      <li class="inline-flex items-center">
        <a href="/" class="text-gray-700 hover:text-nexus-red">
          <i class="fas fa-home"></i> Dashboard
        </a>
      </li>
      <li>
        <div class="flex items-center">
          <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
          <a href="/clients" class="text-gray-700 hover:text-nexus-red">Clienti</a>
        </div>
      </li>
      <li aria-current="page">
        <div class="flex items-center">
          <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
          <span class="text-gray-500">Importa da Bolletta ENEL</span>
        </div>
      </li>
    </ol>
  </nav>
  <h1 class="text-3xl font-bold text-nexus-dark mt-4">
    <i class="fas fa-file-import mr-3 text-blue-600"></i>
    Importa Cliente da Bolletta ENEL
  </h1>
  <p class="text-gray-600 mt-2">
    Carica una bolletta ENEL PDF per estrarre automaticamente i dati anagrafici del cliente
  </p>
  <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-3">
    <div class="flex items-center">
      <i class="fas fa-info-circle text-blue-600 mr-2"></i>
      <span class="text-blue-800 font-medium">Solo Dati Anagrafici</span>
    </div>
    <p class="text-blue-700 text-sm mt-1">
      Questa funzione estrae <strong>solo i dati anagrafici</strong> del cliente. 
      I punti di fornitura dovranno essere inseriti manualmente dalla sezione "Gestione Utenze".
    </p>
  </div>
  <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mt-3">
    <div class="flex items-center">
      <i class="fas fa-exclamation-triangle text-amber-600 mr-2"></i>
      <span class="text-amber-800 font-medium">Funzionalit√† Ottimizzata per ENEL</span>
    </div>
    <p class="text-amber-700 text-sm mt-1">
      Questa funzione √® specificatamente ottimizzata per bollette <strong>ENEL Energia</strong>. 
      Per altri gestori energetici, inserire i dati del cliente manualmente.
    </p>
  </div>
</div>

<div class="max-w-4xl mx-auto">
  <!-- Card Informazioni -->
  <div class="card mb-6 border-l-4 border-blue-500">
    <div class="card-header bg-blue-600 text-white">
      <h4 class="text-lg font-semibold">
        <i class="fas fa-info-circle mr-2"></i>
        Dati Estratti da Bollette ENEL
      </h4>
    </div>
    <div class="card-body">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h5 class="font-semibold text-blue-600 mb-3">üë§ Dati Cliente ENEL</h5>
          <ul class="text-sm space-y-1 text-gray-700">
            <li>‚Ä¢ <strong>Nome e Cognome</strong> separati</li>
            <li>‚Ä¢ <strong>Codice Fiscale</strong> e Partita IVA</li>
            <li>‚Ä¢ <strong>Indirizzo di fornitura</strong> completo</li>
            <li>‚Ä¢ <strong>Citt√†, CAP e Provincia</strong></li>
            <li>‚Ä¢ <strong>Numero Cliente</strong> ENEL</li>
          </ul>
        </div>
        <div>
          <h5 class="font-semibold text-orange-600 mb-3">‚ö° Dati Utenze ENEL</h5>
          <ul class="text-sm space-y-1 text-gray-700">
            <li>‚Ä¢ <strong>Codice POD</strong> (energia elettrica)</li>
            <li>‚Ä¢ <strong>Codice PDR</strong> (gas naturale)</li>
            <li>‚Ä¢ <strong>Consumi annuali</strong> stimati</li>
            <li>‚Ä¢ <strong>Potenza impegnata</strong> (kW)</li>
            <li>‚Ä¢ <strong>Tipologia uso</strong> (domestico/business)</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Form Upload -->
  <div class="card">
    <div class="card-header bg-nexus-dark text-white">
      <h4 class="text-lg font-semibold">
        <i class="fas fa-upload mr-2"></i>
        Carica Bolletta ENEL PDF
      </h4>
    </div>
    <div class="card-body">
      
      <!-- Area Drop Zone -->
      <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors cursor-pointer">
        <div id="dropContent">
          <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
          <h5 class="text-lg font-semibold text-gray-700 mb-2">Trascina qui la bolletta ENEL PDF</h5>
          <p class="text-gray-500 mb-4">oppure clicca per selezionare il file</p>
          <button type="button" class="btn-primary" onclick="document.getElementById('billFile').click()">
            <i class="fas fa-folder-open mr-2"></i>
            Seleziona Bolletta ENEL
          </button>
          <input type="file" id="billFile" name="billFile" accept=".pdf" class="hidden">
          <p class="text-xs text-gray-400 mt-2">Dimensione massima: 10MB | Solo bollette ENEL in formato PDF</p>
        </div>
        
        <!-- Loading State -->
        <div id="loadingState" class="hidden">
          <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
          <h5 class="text-lg font-semibold text-blue-600 mb-2">Elaborazione bolletta ENEL...</h5>
          <p class="text-gray-600">Analisi del contenuto e estrazione automatica dei dati</p>
        </div>
      </div>

      <!-- Risultati -->
      <div id="extractionResults" class="hidden mt-6">
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
          <div class="flex items-center mb-3">
            <i class="fas fa-check-circle text-green-500 text-xl mr-3"></i>
            <h5 class="font-semibold text-green-800">Estrazione Completata!</h5>
          </div>
          
          <div id="extractionSummary" class="mb-4">
            <!-- Popolato da JavaScript -->
          </div>
          
          <div class="flex space-x-3">
            <button type="button" id="createClientBtn" class="btn-primary">
              <i class="fas fa-user-plus mr-2"></i>
              Crea Cliente con Dati Estratti
            </button>
            <button type="button" id="uploadAnotherBtn" class="btn-outline">
              <i class="fas fa-upload mr-2"></i>
              Carica Altra Bolletta
            </button>
          </div>
        </div>
      </div>

      <!-- Errori -->
      <div id="errorResults" class="hidden mt-6">
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
          <div class="flex items-center mb-3">
            <i class="fas fa-exclamation-triangle text-red-500 text-xl mr-3"></i>
            <h5 class="font-semibold text-red-800">Errore nell'Elaborazione</h5>
          </div>
          <p id="errorMessage" class="text-red-700 mb-4"></p>
          <div class="bg-red-100 border border-red-300 rounded p-3 mt-3">
            <p class="text-red-800 text-sm">
              <strong>Suggerimento:</strong> Se il file non √® una bolletta ENEL, 
              <a href="/clients/new" class="text-red-600 underline font-medium">inserisci i dati manualmente</a>
            </p>
          </div>
          <button type="button" id="retryBtn" class="btn-outline mt-3">
            <i class="fas fa-redo mr-2"></i>
            Riprova
          </button>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
let extractedData = null;

// Elementi DOM
const dropZone = document.getElementById('dropZone');
const billFile = document.getElementById('billFile');
const dropContent = document.getElementById('dropContent');
const loadingState = document.getElementById('loadingState');
const extractionResults = document.getElementById('extractionResults');
const extractionSummary = document.getElementById('extractionSummary');
const errorResults = document.getElementById('errorResults');
const errorMessage = document.getElementById('errorMessage');

// Event Listeners
dropZone.addEventListener('dragover', handleDragOver);
dropZone.addEventListener('drop', handleDrop);
billFile.addEventListener('change', handleFileSelect);

document.getElementById('createClientBtn').addEventListener('click', createClientFromData);
document.getElementById('uploadAnotherBtn').addEventListener('click', resetUpload);
document.getElementById('retryBtn').addEventListener('click', resetUpload);

// Drag & Drop
function handleDragOver(e) {
  e.preventDefault();
  dropZone.classList.add('border-blue-400', 'bg-blue-50');
}

function handleDrop(e) {
  e.preventDefault();
  dropZone.classList.remove('border-blue-400', 'bg-blue-50');
  
  const files = e.dataTransfer.files;
  if (files.length > 0) {
    handleFile(files[0]);
  }
}

function handleFileSelect(e) {
  const file = e.target.files[0];
  if (file) {
    handleFile(file);
  }
}

// Processing
function handleFile(file) {
  if (file.type !== 'application/pdf') {
    showError('Solo file PDF sono supportati. Per altri formati, inserire i dati manualmente.');
    return;
  }
  
  if (file.size > 10 * 1024 * 1024) {
    showError('Il file √® troppo grande. Dimensione massima: 10MB');
    return;
  }
  
  // Controlla se il nome del file suggerisce che sia una bolletta ENEL
  const fileName = file.name.toLowerCase();
  if (!fileName.includes('enel') && !fileName.includes('bolletta')) {
    console.warn('‚ö†Ô∏è File potrebbe non essere una bolletta ENEL');
  }
  
  uploadAndProcess(file);
}

function uploadAndProcess(file) {
  hideAllResults();
  dropContent.classList.add('hidden');
  loadingState.classList.remove('hidden');
  
  const formData = new FormData();
  formData.append('billFile', file);
  
  // Aggiungi token CSRF se disponibile
  const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                   '<%= csrfToken %>';
  
  const headers = {};
  if (csrfToken && csrfToken !== '<%= csrfToken %>') {
    formData.append('_csrf', csrfToken);
  }
  
  fetch('/api/test/test', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showSuccess(data);
    } else {
      showError(data.message || 'Errore nell\'elaborazione della bolletta ENEL');
    }
  })
  .catch(error => {
    console.error('Errore upload:', error);
    showError('Errore di connessione. Verificare la connessione internet.');
  });
}

function showSuccess(data) {
  loadingState.classList.add('hidden');
  extractedData = data;
  
  // Mostra dettagli pi√π specifici per ENEL
  const isEnel = data.provider === 'ENEL' || (data.data && data.data.provider === 'ENEL');
  const confidenceColor = (data.confidence || 0) >= 70 ? 'text-green-700' : 
                         (data.confidence || 0) >= 50 ? 'text-yellow-700' : 'text-red-700';
  
  extractionSummary.innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
      <div>
        <span class="font-semibold text-green-700">Fornitore:</span>
        <p class="text-gray-700">${data.provider || 'Non identificato'} ${isEnel ? '‚úÖ' : '‚ö†Ô∏è'}</p>
      </div>
      <div>
        <span class="font-semibold ${confidenceColor}">Confidenza:</span>
        <p class="text-gray-700">${data.confidence || 0}%</p>
      </div>
      <div>
        <span class="font-semibold text-green-700">Campi Estratti:</span>
        <p class="text-gray-700">${Object.keys(data.data || {}).length} campi</p>
      </div>
      <div>
        <span class="font-semibold text-blue-700">Tipo:</span>
        <p class="text-gray-700">${data.data?.billType || 'Generico'}</p>
      </div>
    </div>
    ${!isEnel ? `
    <div class="bg-yellow-50 border border-yellow-200 rounded p-3 mt-3">
      <p class="text-yellow-800 text-sm">
        <i class="fas fa-exclamation-triangle mr-1"></i>
        <strong>Attenzione:</strong> Il file potrebbe non essere una bolletta ENEL. 
        La qualit√† dei dati estratti potrebbe essere ridotta.
      </p>
    </div>
    ` : ''}
  `;
  
  extractionResults.classList.remove('hidden');
}

function showError(message) {
  loadingState.classList.add('hidden');
  errorMessage.textContent = message;
  errorResults.classList.remove('hidden');
}

function hideAllResults() {
  extractionResults.classList.add('hidden');
  errorResults.classList.add('hidden');
}

function resetUpload() {
  billFile.value = '';
  extractedData = null;
  hideAllResults();
  loadingState.classList.add('hidden');
  dropContent.classList.remove('hidden');
}

function createClientFromData() {
  if (!extractedData || !extractedData.data) {
    alert('Nessun dato estratto disponibile');
    return;
  }
  
  const encodedData = encodeURIComponent(JSON.stringify(extractedData.data));
  window.location.href = `/clients/new-from-bill?data=${encodedData}`;
}
</script>