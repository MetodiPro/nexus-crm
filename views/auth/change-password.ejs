<div class="max-w-md mx-auto">
  <div class="card">
    <div class="card-header bg-nexus-dark text-white">
      <h4 class="text-lg font-semibold">
        <i class="fas fa-key"></i> Cambia Password
      </h4>
    </div>
    <div class="card-body">
      <% if (typeof success !== 'undefined' && success) { %>
        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
          <i class="fas fa-check-circle mr-2"></i> <%= success %>
        </div>
      <% } %>
      
      <% if (typeof error !== 'undefined' && error) { %>
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
          <i class="fas fa-exclamation-circle mr-2"></i> <%= error %>
        </div>
      <% } %>

      <!-- Linee guida sicurezza -->
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
        <h6 class="text-blue-800 font-semibold mb-2">
          <i class="fas fa-shield-alt mr-1"></i> Requisiti Password
        </h6>
        <ul class="text-blue-700 text-sm space-y-1">
          <li><i class="fas fa-check mr-1"></i> Minimo 8 caratteri</li>
          <li><i class="fas fa-check mr-1"></i> Almeno una lettera minuscola</li>
          <li><i class="fas fa-check mr-1"></i> Almeno una lettera maiuscola</li>
          <li><i class="fas fa-check mr-1"></i> Almeno un numero</li>
        </ul>
      </div>

      <form action="/change-password" method="POST">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        
        <div class="form-group">
          <label for="currentPassword" class="form-label">Password Attuale *</label>
          <div class="relative">
            <input type="password" 
                   id="currentPassword" 
                   name="currentPassword" 
                   class="form-input pr-10" 
                   required
                   autocomplete="current-password">
            <button type="button" 
                    class="absolute inset-y-0 right-0 pr-3 flex items-center"
                    onclick="togglePassword('currentPassword')">
              <i class="fas fa-eye text-gray-400" id="currentPassword-icon"></i>
            </button>
          </div>
        </div>

        <div class="form-group">
          <label for="newPassword" class="form-label">Nuova Password *</label>
          <div class="relative">
            <input type="password" 
                   id="newPassword" 
                   name="newPassword" 
                   class="form-input pr-10" 
                   required
                   autocomplete="new-password"
                   minlength="8">
            <button type="button" 
                    class="absolute inset-y-0 right-0 pr-3 flex items-center"
                    onclick="togglePassword('newPassword')">
              <i class="fas fa-eye text-gray-400" id="newPassword-icon"></i>
            </button>
          </div>
          <div id="password-strength" class="mt-2"></div>
        </div>

        <div class="form-group">
          <label for="confirmPassword" class="form-label">Conferma Nuova Password *</label>
          <div class="relative">
            <input type="password" 
                   id="confirmPassword" 
                   name="confirmPassword" 
                   class="form-input pr-10" 
                   required
                   autocomplete="new-password"
                   minlength="8">
            <button type="button" 
                    class="absolute inset-y-0 right-0 pr-3 flex items-center"
                    onclick="togglePassword('confirmPassword')">
              <i class="fas fa-eye text-gray-400" id="confirmPassword-icon"></i>
            </button>
          </div>
          <div id="password-match" class="mt-2"></div>
        </div>

        <div class="flex justify-between items-center mt-6">
          <a href="/users/profile" class="btn-outline-gray">
            <i class="fas fa-arrow-left mr-1"></i> Annulla
          </a>
          <button type="submit" class="btn-nexus" id="submit-btn" disabled>
            <i class="fas fa-key mr-1"></i> Cambia Password
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function togglePassword(fieldId) {
  const field = document.getElementById(fieldId);
  const icon = document.getElementById(fieldId + '-icon');
  
  if (field.type === 'password') {
    field.type = 'text';
    icon.classList.remove('fa-eye');
    icon.classList.add('fa-eye-slash');
  } else {
    field.type = 'password';
    icon.classList.remove('fa-eye-slash');
    icon.classList.add('fa-eye');
  }
}

function checkPasswordStrength(password) {
  const strengthIndicator = document.getElementById('password-strength');
  let strength = 0;
  let feedback = [];

  if (password.length >= 8) strength++;
  else feedback.push('Almeno 8 caratteri');

  if (/[a-z]/.test(password)) strength++;
  else feedback.push('Una lettera minuscola');

  if (/[A-Z]/.test(password)) strength++;
  else feedback.push('Una lettera maiuscola');

  if (/\d/.test(password)) strength++;
  else feedback.push('Un numero');

  if (/[^A-Za-z0-9]/.test(password)) strength++;

  const colors = ['bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-blue-500', 'bg-green-500'];
  const labels = ['Molto debole', 'Debole', 'Discreta', 'Buona', 'Molto forte'];

  if (password.length === 0) {
    strengthIndicator.innerHTML = '';
    return false;
  }

  const strengthBar = `
    <div class="text-xs mb-1">Forza password: <span class="font-semibold">${labels[strength - 1] || 'Molto debole'}</span></div>
    <div class="w-full bg-gray-200 rounded-full h-2">
      <div class="${colors[strength - 1] || 'bg-red-500'} h-2 rounded-full transition-all duration-300" style="width: ${(strength / 5) * 100}%"></div>
    </div>
  `;

  if (feedback.length > 0) {
    strengthIndicator.innerHTML = strengthBar + `
      <div class="text-xs text-red-600 mt-1">
        Mancano: ${feedback.join(', ')}
      </div>
    `;
  } else {
    strengthIndicator.innerHTML = strengthBar;
  }

  return strength >= 4;
}

function checkPasswordMatch() {
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  const matchIndicator = document.getElementById('password-match');
  const submitBtn = document.getElementById('submit-btn');

  if (confirmPassword.length === 0) {
    matchIndicator.innerHTML = '';
    submitBtn.disabled = true;
    return false;
  }

  if (newPassword === confirmPassword) {
    matchIndicator.innerHTML = '<div class="text-xs text-green-600"><i class="fas fa-check mr-1"></i>Le password coincidono</div>';
    const isStrong = checkPasswordStrength(newPassword);
    submitBtn.disabled = !isStrong;
    return true;
  } else {
    matchIndicator.innerHTML = '<div class="text-xs text-red-600"><i class="fas fa-times mr-1"></i>Le password non coincidono</div>';
    submitBtn.disabled = true;
    return false;
  }
}

// Event listeners
document.getElementById('newPassword').addEventListener('input', function() {
  checkPasswordStrength(this.value);
  checkPasswordMatch();
});

document.getElementById('confirmPassword').addEventListener('input', checkPasswordMatch);

document.getElementById('currentPassword').addEventListener('input', function() {
  const submitBtn = document.getElementById('submit-btn');
  if (this.value.length === 0) {
    submitBtn.disabled = true;
  } else {
    checkPasswordMatch();
  }
});
</script>